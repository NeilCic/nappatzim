generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String                    @id @default(uuid())
  email                    String                    @unique
  passwordHash             String
  role                     String                    @default("user")
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  username                 String?                   @unique
  height                   Float?
  preferredGradeSystem     String?
  climbs                   Climb[]
  climbComments            ClimbComment[]
  climbVideos              ClimbVideo[]
  climbReactions           ClimbCommentReaction[]
  climbVotes               ClimbGradeVote[]
  conversationParticipants ConversationParticipant[]
  exerciseProgress         ExerciseProgress[]
  sentMessages             Message[]
  spots                    Spot[]
  workouts                 Workout[]
  categories               WorkoutCategory[]
  climbingSessions         ClimbingSession[]
}

model WorkoutCategory {
  id               String             @id @default(cuid())
  name             String
  color            String?
  userId           String
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  exerciseProgress ExerciseProgress[]
  workouts         Workout[]
  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId])
}

model Workout {
  id         String          @id @default(cuid())
  notes      String?
  categoryId String
  userId     String
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  exercises  Exercise[]
  category   WorkoutCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  user       User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, categoryId])
  @@index([categoryId, createdAt])
}

model Exercise {
  id         String        @id @default(cuid())
  workoutId  String
  type       String
  name       String
  unit       String?
  notes      String?
  order      Int
  workout    Workout       @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  setsDetail ExerciseSet[]

  @@index([workoutId, order])
}

model ExerciseSet {
  id          String   @id @default(cuid())
  exerciseId  String
  order       Int
  value       Float    @default(0)
  reps        Int?
  restMinutes Float?
  exercise    Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@unique([exerciseId, order])
}

model ExerciseProgress {
  id             String          @id @default(cuid())
  name           String
  normalizedName String
  type           String
  unit           String?
  userId         String
  categoryId     String
  totalVolume    Float           @default(0)
  totalReps      Int             @default(0)
  maxWeight      Float           @default(0)
  progress       Json            @default("[]")
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  category       WorkoutCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId, normalizedName])
  @@index([userId])
  @@index([categoryId])
}

model Conversation {
  id           String                    @id @default(cuid())
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  participants ConversationParticipant[]
  messages     Message[]
}

model ConversationParticipant {
  conversationId String
  userId         String
  role           String       @default("member")
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([conversationId, userId])
  @@index([userId])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  senderId       String
  content        String
  createdAt      DateTime     @default(now())
  readAt         DateTime?
  workoutData    Json?
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([senderId])
}

model Layout {
  id                  String   @id @default(cuid())
  name                String
  layoutImageUrl      String
  layoutImagePublicId String
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  gradeSystem         String
  noMatchColor        String?
  spots               Spot[]

  @@index([createdAt])
}

model Spot {
  id          String   @id @default(cuid())
  name        String   @db.VarChar(20)
  description String?
  color       String?
  x           Float
  y           Float
  layoutId    String
  userId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  climbs      Climb[]
  layout      Layout   @relation(fields: [layoutId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([layoutId, name])
  @@index([layoutId])
  @@index([userId])
  @@index([layoutId, userId])
}

model ClimbVideo {
  id            String   @id @default(cuid())
  title         String?
  description   String?
  videoUrl      String
  videoPublicId String
  thumbnailUrl  String?
  fileSize      Int
  duration      Float?
  climbId       String
  userId        String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  climb         Climb    @relation(fields: [climbId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([climbId])
  @@index([climbId, createdAt])
  @@index([userId])
  @@unique([climbId, userId])
}

model Climb {
  id          String           @id @default(cuid())
  spotId      String
  grade       String
  gradeSystem String
  color       String
  length      Float?
  setterId    String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  setter      User?            @relation(fields: [setterId], references: [id])
  spot        Spot             @relation(fields: [spotId], references: [id], onDelete: Cascade)
  comments    ClimbComment[]
  votes       ClimbGradeVote[]
  videos      ClimbVideo[]

  @@index([spotId])
  @@index([setterId])
  @@index([spotId, createdAt])
}

model ClimbGradeVote {
  id          String   @id @default(cuid())
  climbId     String
  userId      String
  grade       String
  gradeSystem String
  height      Float?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  descriptors String[] @default([])
  climb       Climb    @relation(fields: [climbId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([climbId, userId])
  @@index([climbId])
  @@index([userId])
}

model ClimbComment {
  id              String                 @id @default(cuid())
  climbId         String
  userId          String
  parentCommentId String?
  content         String
  likes           Int                    @default(0)
  dislikes        Int                    @default(0)
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  editedAt        DateTime?
  climb           Climb                  @relation(fields: [climbId], references: [id], onDelete: Cascade)
  parentComment   ClimbComment?          @relation("CommentReplies", fields: [parentCommentId], references: [id], onDelete: Cascade)
  replies         ClimbComment[]         @relation("CommentReplies")
  user            User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  reactions       ClimbCommentReaction[]

  @@index([climbId, createdAt])
  @@index([userId])
  @@index([parentCommentId])
}

model ClimbCommentReaction {
  id        String       @id @default(cuid())
  commentId String
  userId    String
  reaction  String
  createdAt DateTime     @default(now())
  comment   ClimbComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
}

model ClimbingSession {
  id        String                @id @default(cuid())
  userId    String
  startTime DateTime
  endTime   DateTime?
  notes     String?               @db.Text
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt
  user      User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  attempts  SessionRoute[]

  @@index([userId, createdAt])
  @@index([userId])
}

model SessionRoute {
  id            String          @id @default(cuid())
  sessionId     String
  climbId       String?
  proposedGrade String
  gradeSystem   String
  voterGrade    String?
  descriptors   String[]        @default([])
  status        String // 'success' | 'failure'
  attempts      Int
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  session       ClimbingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, climbId])
  @@index([sessionId])
  @@index([climbId])
}
